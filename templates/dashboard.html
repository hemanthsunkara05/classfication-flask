<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Live Sensor Dashboard - MQ-5 Only</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

</head>
<body>
    <div class="container">
        <h1>üìä Live Sensor Dashboard (MQ-5 Gas Sensor Only)</h1>

        <!-- Remove the Start Monitoring button and anomaly-sound audio element -->

        <div class="center">
            <a class="download-button" href="/download">‚¨áÔ∏è Download CSV</a>
        </div>

        <label for="sensorFilter">Select Sensor Type:</label>
        <select id="sensorFilter" disabled>
            <option value="mq5_01">MQ-5 Gas Sensor</option>
        </select>

        <canvas id="sensorChart" width="800" height="400"></canvas>

        <table id="data-table">
            <thead>
                <tr>
                    <th>Sensor ID</th>
                    <th>Value</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

<script>
let myChart;

function getColor(sensor) {
    return 'red';  // Only MQ-5, so fixed color
}

async function fetchData() {
    const response = await fetch('/dashboard-data');
    const data = await response.json();

    console.log("Fetched data:", data);
    console.log("Timestamps:", data.map(d => d.timestamp));

    const filtered = data;  // Only one sensor, no filtering needed

    // Group data by sensor type (still generic for future-proofing)
    const sensorGroups = {};
    filtered.forEach(d => {
        if (!sensorGroups[d.sensor_type]) {
            sensorGroups[d.sensor_type] = {
                timestamps: [],
                values: [],
                anomalies: []
            };
        }
        sensorGroups[d.sensor_type].timestamps.push(d.timestamp);
        sensorGroups[d.sensor_type].values.push(d.value);
        sensorGroups[d.sensor_type].anomalies.push(d.anomaly);
    });

    const datasets = Object.keys(sensorGroups).map(sensor => {
        const group = sensorGroups[sensor];
        return {
            label: "MQ-5 Gas Sensor",
            data: group.timestamps.map((t, i) => ({ x: t, y: group.values[i] })),
            borderColor: 'red', // force visible color
            backgroundColor: 'red',
            borderWidth: 3,
            fill: false,
            showLine: true,
            pointRadius: 8,
            pointBackgroundColor: 'red', // single color for all points
            spanGaps: true // force line connection even if gaps
        };
    });

    console.log("Datasets for Chart.js:", datasets);
    console.log("Final dataset for Chart.js:", datasets);
    // Always destroy the old chart before creating a new one
    const ctx = document.getElementById('sensorChart').getContext('2d');
    if (myChart) {
        myChart.destroy();
    }
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: datasets
        },
        options: {
            responsive: true,
            showLine: true,
            elements: {
                point: {
                    radius: 8,
                    borderWidth: 2
                },
                line: {
                    borderWidth: 3
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        tooltipFormat: 'MMM d, h:mm:ss a',
                        unit: 'minute',
                        displayFormats: {
                            minute: 'h:mm a'
                        }
                    },
                    title: { display: true, text: 'Time' }
                },
                y: {
                    title: { display: true, text: 'Sensor Value' }
                }
            }
        }
    });

    // Populate table with latest data (max 10 rows)
    const tbody = document.getElementById("data-table").querySelector("tbody");
    tbody.innerHTML = "";
    filtered.slice(-10).reverse().forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.sensor_id}</td>
            <td>${row.value}</td>
            <td>${row.timestamp}</td>
        `;
        if (row.anomaly === 1) {
            tr.style.backgroundColor = '#ffcccc'; // light red for anomaly
            tr.style.color = 'red';
            tr.style.fontWeight = 'bold';
        }
        tbody.appendChild(tr);
    });
}

// Initial load and set refresh interval
fetchData();
setInterval(fetchData, 10000);
</script>

</body>
</html>
